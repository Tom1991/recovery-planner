<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Recovery Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; max-width: 900px; margin: 40px auto; background: #f5f7f8; color: #333; }
h1 { text-align: center; }
button.tabBtn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; background: #eee; transition: background 0.2s; }
button.tabBtn.active { background: #4caf50; color: #fff; }
button.tabBtn:hover { background: #ddd; }
form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select, button, textarea { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
textarea { width: 100%; min-height: 60px; resize: vertical; }
button.submitBtn { background: #4caf50; color: white; cursor: pointer; border: none; transition: background 0.2s; }
button.submitBtn:hover { background: #43a047; }

.event { padding: 10px; border-left: 4px solid #4caf50; background: #fff; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
.event-info { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; font-size: 0.9em; color:#444; }
.event-info a { font-size:0.9em; color:#1976d2; text-decoration:none; }
.event-info a:hover { text-decoration:underline; }

.AA { border-color: #1976d2; }
.Personal { border-color: #4caf50; }
.Reminder { border-color: #ff9800; }

#todayDashboard { padding:16px; background:#e6f4ea; border-radius:12px; margin-bottom:24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.links a { display: inline-block; margin-bottom: 6px; color:#1976d2; text-decoration:none; }
.links a:hover { text-decoration: underline; }
.sober { font-size: 1.4em; font-weight: bold; margin-bottom: 16px; }
.deleteBtn { background: #e53935; margin-left: 8px; padding: 4px 8px; border:none; border-radius:4px; color:white; cursor:pointer; }
.deleteBtn:hover { background: #d32f2f; }

#diaryForm label { width: 100%; margin-top: 8px; font-weight: bold; }
#diaryForm input[type="text"], #diaryForm textarea, #diaryForm input[type="number"] { width: 100%; }
</style>
</head>
<body>
<h1>üå± Recovery Planner</h1>

<!-- Tabs -->
<div id="nav" style="display:flex; gap:16px; margin-bottom:24px; justify-content:center;">
  <button class="tabBtn active" onclick="showTab('today')">Today</button>
  <button class="tabBtn" onclick="showTab('schedule')">Scheduler</button>
  <button class="tabBtn" onclick="showTab('risk')">Risk Cycle</button>
  <button class="tabBtn" onclick="showTab('diary')">Diary</button>
</div>

<!-- Today Tab -->
<div id="todayTab">
  <div id="todayDashboard">
    <h2>Today</h2>
    <div id="todayDate"></div>
    <div id="todaySober">‚ú® Loading...</div>

    <h3>Today's Affirmation</h3>
    <div id="todayAffirmation" style="font-style:italic; margin-bottom:16px;">Loading...</div>

    <h3>Today's Events</h3>
    <div id="todayEvents">Loading...</div>

    <h3>Upcoming Events This Week</h3>
    <div id="weekEvents">Loading...</div>
  </div>
</div>

<!-- Schedule Tab -->
<div id="scheduleTab" style="display:none;">
  <div class="sober" id="soberCounter">‚ú® Loading...</div>

  <form id="sobrietyForm">
    <label>Sobriety start date:</label>
    <input type="date" id="sobrietyStart" />
    <button class="submitBtn">Save</button>
  </form>

  <h2>Add Event / Meeting</h2>
  <form id="eventForm">
    <input placeholder="Title" id="title" required />
    <select id="category">
      <option>Personal</option>
      <option>AA</option>
      <option>Reminder</option>
    </select>
    <input type="datetime-local" id="start" required />
    <input type="datetime-local" id="end" required />
    <input placeholder="Optional link" id="link" />
    <select id="recurrence">
      <option>None</option>
      <option>Daily</option>
      <option>Weekly</option>
    </select>
    <button class="submitBtn">Add</button>
  </form>

  <h2>Your Schedule</h2>
  <div id="events"></div>
</div>

<!-- Risk Cycle Tab -->
<div id="riskTab" style="display:none;" class="card">
  <h2>üß† 2‚Äì3 Week Cycle Prevention & Honesty Plan</h2>
  <p><strong>Purpose:</strong> Interrupt my predictable 2‚Äì3 week risk cycle by prioritising early connection, low‚Äëdetail honesty, and nervous‚Äësystem regulation.</p>

  <h3>1. Name the Pattern</h3>
  <p><strong>Cycle name:</strong> The Danger Zone<br><strong>Typical timing:</strong> Around weeks 2‚Äì3 after a stable period.</p>
  <hr>

  <h3>2. Early Warning Signs</h3>
  <ul>
    <li>‚òê Avoiding check ins</li>
    <li>‚òê Thinking "I don‚Äôt want to burden anyone"</li>
    <li>‚òê Fantasising about relief/escape</li>
    <li>‚òê Thinking about future events where a drink "won't be allowed"</li>
    <li>‚òê Not filling in my diary within 24 hours</li>
  </ul>
  <p><strong>Rule:</strong> If two or more, act immediately ‚Äî no debate.</p>
  <hr>

  <h3>3. Time-Based Intervention</h3>
  <p>On Day <b>12‚Äì22</b>, proactively check in.<br>Or every weekend regardless of mood.<br><strong>Time beats feelings.</strong></p>
  <hr>

  <h3>4. Who I Tell</h3>
  <p><strong>Primary:</strong> Natalie<br><strong>Secondary:</strong> Carl</p>
  <hr>

  <h3>5. Pre-Written Disclosures</h3>
  <ul>
    <li>‚ÄúI‚Äôm heading into a risky period of time‚Äù</li>
    <li>‚ÄúNothing‚Äôs wrong yet, but this is when my head gets louder.‚Äù</li>
    <li>‚ÄúI'm just letting you know that around now is when my thoughts lead to a lapse‚Äù</li>
  </ul>
  <p>I do <b>not</b> explain or predict relapse.</p>
  <hr>

  <h3>6. Mandatory Regulation</h3>
  <ul>
    <li>‚òê 5 slow breaths</li>
    <li>‚òê Cold water on face</li>
    <li>‚òê Short bike cycle</li>
    <li>‚òê Feet on floor, name 5 things you see</li>
  </ul>
  <hr>

  <h3>7. What Help Looks Like</h3>
  <ul>
    <li>‚òê Listening, not fixing</li>
    <li>‚òê Brief daily check-ins</li>
    <li>‚òê Reassurance</li>
    <li>‚òê More structure</li>
  </ul>
  <hr>

  <h3>8. If a Lapse Happens</h3>
  <p>Imperfection is planned ‚Äî secrecy is not.<br><b>Timeframe:</b> Same day before bed<br><b>Format:</b> One sentence<br><b>Boundary:</b> ‚ÄúI don't want to go through every detail repeatedly‚Äù</p>
  <ul>
    <li>‚ÄúI had a slip. I‚Äôm safe now, and I wanted to say it early rather than hide.‚Äù</li>
  </ul>
  <hr>

  <h3>9. Anchor Statement</h3>
  <p>‚ÄúMy job isn‚Äôt to stay sober perfectly ‚Äî it‚Äôs to stay connected early.‚Äùp>
</div>

<!-- Diary Tab -->
<div id="diaryTab" style="display:none;">
  <h2>üìù Today's Diary</h2>
  <form id="diaryForm">
    <label>Goal for the day:</label>
    <input type="text" id="diaryGoal" placeholder="My goal for today" />

    <label>3 Things I am grateful for today:</label>
    <input type="text" id="grateful1" placeholder="1" />
    <input type="text" id="grateful2" placeholder="2" />
    <input type="text" id="grateful3" placeholder="3" />

    <label>3 Emotions:</label>
    <input type="text" id="emotion1" placeholder="1" />
    <input type="text" id="emotion2" placeholder="2" />
    <input type="text" id="emotion3" placeholder="3" />

    <label>Cravings (0-10):</label>
    <input type="number" id="cravings" min="0" max="10" />

    <label>Morning:</label>
    <textarea id="morning" placeholder="Morning notes..."></textarea>

    <label>Afternoon:</label>
    <textarea id="afternoon" placeholder="Afternoon notes..."></textarea>

    <label>Evening:</label>
    <textarea id="evening" placeholder="Evening notes..."></textarea>

    <button class="submitBtn">Save Diary</button>
  </form>
</div>

<h2>Helpful Links</h2>
<div class="links">
  <a href="https://www.alcoholics-anonymous.org.uk/" target="_blank">Alcoholics Anonymous</a>
  <a href="https://www.alcoholics-anonymous.org.uk/find-a-meeting/" target="_blank">Online AA Meetings</a>
  <a href="https://www.avfyww.com" target="_blank">Home Meeting</a>
</div>

<script src="affirmations.js"></script>
<script>
// Elements
const title=document.getElementById('title');
const category=document.getElementById('category');
const start=document.getElementById('start');
const end=document.getElementById('end');
const link=document.getElementById('link');
const recurrence=document.getElementById('recurrence');
const sobrietyStart=document.getElementById('sobrietyStart');
const eventForm=document.getElementById('eventForm');
const sobrietyForm=document.getElementById('sobrietyForm');
const soberCounter=document.getElementById('soberCounter');
const eventsDiv=document.getElementById('events');
const todayDate=document.getElementById('todayDate');
const todaySober=document.getElementById('todaySober');
const todayEventsDiv=document.getElementById('todayEvents');
const weekEventsDiv=document.getElementById('weekEvents');
const todayAffirmationDiv=document.getElementById('todayAffirmation');

// Diary Elements
const diaryForm=document.getElementById('diaryForm');
const diaryGoal=document.getElementById('diaryGoal');
const grateful1=document.getElementById('grateful1');
const grateful2=document.getElementById('grateful2');
const grateful3=document.getElementById('grateful3');
const emotion1=document.getElementById('emotion1');
const emotion2=document.getElementById('emotion2');
const emotion3=document.getElementById('emotion3');
const cravings=document.getElementById('cravings');
const morning=document.getElementById('morning');
const afternoon=document.getElementById('afternoon');
const evening=document.getElementById('evening');

// Utilities
function daysBetween(start){return Math.floor((new Date()-new Date(start))/(1000*60*60*24));}
function showTab(tab){
  document.getElementById('todayTab').style.display=tab==='today'?'block':'none';
  document.getElementById('scheduleTab').style.display=tab==='schedule'?'block':'none';
  document.getElementById('riskTab').style.display=tab==='risk'?'block':'none';
  document.getElementById('diaryTab').style.display=tab==='diary'?'block':'none'?false:true;
  document.querySelectorAll('.tabBtn').forEach(btn=>btn.classList.remove('active'));
  document.querySelector(`button[onclick*='${tab}']`).classList.add('active');
}
function nextOccurrence(e){const s=new Date(e.start);const today=new Date(); today.setHours(0,0,0,0); if(e.recurrence==='None') return s; if(e.recurrence==='Daily') return today<s?s:today; if(e.recurrence==='Weekly'){const dowDiff=(s.getDay()-today.getDay()+7)%7;const next=new Date(today); next.setDate(today.getDate()+dowDiff); return next<s?s:next;} return s;}

// Load sobriety
async function loadSobriety(){const res=await fetch('/api/sobriety'); if(!res.ok) return; const data=await res.json(); if(data.start_date){const days=daysBetween(data.start_date); soberCounter.textContent=`‚ú® ${days} days sober`; todaySober.textContent=`‚ú® ${days} days sober`; }}

// Load events
async function loadEvents(){
  const res=await fetch('/api/events'); if(!res.ok) return; const allEvents=await res.json();
  eventsDiv.innerHTML=''; todayEventsDiv.innerHTML=''; weekEventsDiv.innerHTML='';

  // Schedule tab
  allEvents.forEach(e=>{
    const s=new Date(e.start), en=new Date(e.end);
    const el=document.createElement('div'); el.className=`event ${e.category}`;
    const info=document.createElement('div'); info.className='event-info';
    info.innerHTML=`<strong>${e.title}</strong> ${e.recurrence!=='None'?`<span style="font-size:0.85em;color:#666;">üîÅ ${e.recurrence}</span>`:''} ${s.toLocaleDateString()} ${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}‚Äì${en.toLocaleDateString()} ${en.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${e.link?`<a href='${e.link}' target='_blank'>Link</a>`:''}`;
    const del=document.createElement('button'); del.textContent='Delete'; del.className='deleteBtn'; del.onclick=async()=>{if(!confirm(`Delete "${e.title}"?`)) return; await fetch(`/api/events/${e.id}`,{method:'DELETE'}); loadEvents();};
    el.appendChild(info); el.appendChild(del); eventsDiv.appendChild(el);
  });

  const today=new Date(); today.setHours(0,0,0,0);
  const todayEvents=allEvents.filter(e=>nextOccurrence(e).toDateString()===today.toDateString());
  if(todayEvents.length===0) todayEventsDiv.textContent='No events today.';
  else todayEvents.forEach(e=>{
    const s=new Date(e.start), en=new Date(e.end);
    const el=document.createElement('div'); el.className=`event ${e.category}`;
    const info=document.createElement('div'); info.className='event-info';
    info.innerHTML=`<strong>${e.title}</strong> ${e.recurrence!=='None'?`<span style="font-size:0.85em;color:#666;">üîÅ ${e.recurrence}</span>`:''} ${s.toLocaleDateString()} ${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}‚Äì${en.toLocaleDateString()} ${en.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${e.link?`<a href='${e.link}' target='_blank'>Link</a>`:''}`;
    const del=document.createElement('button'); del.textContent='Delete'; del.className='deleteBtn'; del.onclick=async()=>{if(!confirm(`Delete "${e.title}"?`)) return; await fetch(`/api/events/${e.id}`,{method:'DELETE'}); loadEvents();};
    el.appendChild(info); el.appendChild(del); todayEventsDiv.appendChild(el);
  });

  const nextWeek=new Date(today); nextWeek.setDate(today.getDate()+7);
  const weekEvents=allEvents.filter(e=>{const n=nextOccurrence(e); return n>today && n<=nextWeek;});
  if(weekEvents.length===0) weekEventsDiv.textContent='No upcoming events this week.';
  else weekEvents.forEach(e=>{
    const s=new Date(e.start), en=new Date(e.end);
    const el=document.createElement('div'); el.className=`event ${e.category}`;
    const info=document.createElement('div'); info.className='event-info';
    info.innerHTML=`<strong>${e.title}</strong> ${e.recurrence!=='None'?`<span style="font-size:0.85em;color:#666;">üîÅ ${e.recurrence}</span>`:''} ${s.toLocaleDateString()} ${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}‚Äì${en.toLocaleDateString()} ${en.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${e.link?`<a href='${e.link}' target='_blank'>Link</a>`:''}`;
    const del=document.createElement('button'); del.textContent='Delete'; del.className='deleteBtn'; del.onclick=async()=>{if(!confirm(`Delete "${e.title}"?`)) return; await fetch(`/api/events/${e.id}`,{method:'DELETE'}); loadEvents();};
    el.appendChild(info); el.appendChild(del); weekEventsDiv.appendChild(el);
  });
}

// Affirmation
function setAffirmation(){const today=new Date(); const dayOfYear=Math.floor((today-new Date(today.getFullYear(),0,0))/(1000*60*60*24)); todayAffirmationDiv.textContent=affirmations[dayOfYear % affirmations.length];}

// Load Diary
async function loadDiary(){
  const res=await fetch('/api/diary/today');
  if(!res.ok) return;
  const data=await res.json();
  if(!data) return;
  diaryGoal.value=data.goal||'';
  grateful1.value=data.grateful1||'';
  grateful2.value=data.grateful2||'';
  grateful3.value=data.grateful3||'';
  emotion1.value=data.emotion1||'';
  emotion2.value=data.emotion2||'';
  emotion3.value=data.emotion3||'';
  cravings.value=data.cravings||'';
  morning.value=data.morning||'';
  afternoon.value=data.afternoon||'';
  evening.value=data.evening||'';
}

// Save Diary
async function saveDiary(){
  const payload={
    goal: diaryGoal.value,
    grateful1: grateful1.value,
    grateful2: grateful2.value,
    grateful3: grateful3.value,
    emotion1: emotion1.value,
    emotion2: emotion2.value,
    emotion3: emotion3.value,
    cravings: cravings.value,
    morning: morning.value,
    afternoon: afternoon.value,
    evening: evening.value
  };
  await fetch('/api/diary/today',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  alert('Diary saved!');
}

// On load
window.addEventListener('DOMContentLoaded',()=>{
  todayDate.textContent=new Date().toDateString();
  loadSobriety();
  loadEvents();
  setAffirmation();
  loadDiary();

  sobrietyForm.onsubmit=async e=>{e.preventDefault(); await fetch('/api/sobriety',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({start_date: sobrietyStart.value})}); loadSobriety();};
  eventForm.onsubmit=async e=>{e.preventDefault(); await fetch('/api/events',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({title:title.value,category:category.value,start:start.value,end:end.value,link:link.value,recurrence:recurrence.value})}); loadEvents(); eventForm.reset();};
  diaryForm.onsubmit=async e=>{e.preventDefault(); await saveDiary();};
});
</script>
</body>
</html>

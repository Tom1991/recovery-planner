<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Recovery Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; max-width: 900px; margin: 40px auto; background: #f5f7f8; color: #333; }
h1 { text-align: center; }
button.tabBtn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; background: #eee; transition: background 0.2s; }
button.tabBtn.active { background: #4caf50; color: #fff; }
button.tabBtn:hover { background: #ddd; }
form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
button.submitBtn { background: #4caf50; color: white; cursor: pointer; border: none; transition: background 0.2s; }
button.submitBtn:hover { background: #43a047; }
.event { padding: 10px; border-left: 4px solid #4caf50; background: #fff; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
.AA { border-color: #1976d2; }
.Personal { border-color: #4caf50; }
.Reminder { border-color: #ff9800; }
#todayDashboard { padding:16px; background:#e6f4ea; border-radius:12px; margin-bottom:24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.links a { display: inline-block; margin-bottom: 6px; color:#1976d2; text-decoration:none; }
.links a:hover { text-decoration: underline; }
.sober { font-size: 1.4em; font-weight: bold; margin-bottom: 16px; }
.deleteBtn { background: #e53935; margin-left: 8px; }
.deleteBtn:hover { background: #d32f2f; }
</style>
</head>
<body>
<h1>ğŸŒ± Recovery Planner</h1>

<!-- Navigation Tabs -->
<div id="nav" style="display:flex; gap:16px; margin-bottom:24px; justify-content:center;">
  <button class="tabBtn active" onclick="showTab('today')">Today</button>
  <button class="tabBtn" onclick="showTab('schedule')">Scheduler</button>
  <button class="tabBtn" onclick="showTab('risk')">Risk Cycle</button>
</div>

<!-- Today Tab -->
<div id="todayTab">
  <div id="todayDashboard">
    <h2>Today</h2>
    <div id="todayDate"></div>
    <div id="todaySober">âœ¨ Loading...</div>
    <h3>Today's Events</h3>
    <div id="todayEvents">Loading...</div>
    <h3>Upcoming Events This Week</h3>
    <div id="weekEvents">Loading...</div>
  </div>
</div>

<!-- Schedule Tab -->
<div id="scheduleTab" style="display:none;">
  <div class="sober" id="soberCounter">âœ¨ Loading...</div>

  <form id="sobrietyForm">
    <label>Sobriety start date:</label>
    <input type="date" id="sobrietyStart" />
    <button class="submitBtn">Save</button>
  </form>

  <h2>Add Event / Meeting</h2>
  <form id="eventForm">
    <input placeholder="Title" id="title" required />
    <select id="category">
      <option>Personal</option>
      <option>AA</option>
      <option>Reminder</option>
    </select>
    <input type="datetime-local" id="start" required />
    <input type="datetime-local" id="end" required />
    <input placeholder="Optional link" id="link" />
    <select id="recurrence">
      <option>None</option>
      <option>Daily</option>
      <option>Weekly</option>
    </select>
    <button class="submitBtn">Add</button>
  </form>

  <h2>Your Schedule</h2>
  <div id="events"></div>
</div>

<!-- Risk Cycle Tab -->
<div id="riskTab" style="display:none;" class="card">
<h2>ğŸ§  2â€“3 Week Cycle Prevention & Honesty Plan</h2>
<p><strong>Purpose:</strong> Interrupt my predictable 2â€“3 week risk cycle by prioritising early connection, lowâ€‘detail honesty, and nervousâ€‘system regulation.</p>

<h3>1. Name the Pattern</h3>
<p><strong>Cycle name:</strong> The Danger Zone<br>
<strong>Typical timing:</strong> Around weeks 2 to 3 weeks after a stable period.</p>
<hr>

<h3>2. Early Warning Signs (Before Urges)</h3>
<p>When this phase starts, I often notice:</p>
<ul>
<li>â˜ Avoiding check ins</li>
<li>â˜ Thinking "I donâ€™t want to burden anyone"</li>
<li>â˜ Fantasising about relief/escape</li>
<li>â˜ Thinking about future events where a drink "won't be allowed"</li>
<li>â˜ Not filling in my diary at least within 24 hours of the day before</li>
</ul>
<p><strong>Rule:</strong> If I notice two or more of these, I act â€” no debate.</p>
<hr>

<h3>3. Timeâ€‘Based Intervention Rule - To be removed post risk period</h3>
<p>I do not wait until I feel bad enough.<br><br>
On Day <b>12 to 22</b>, I proactively check in.<br>
OR: Every weekend, regardless of mood.<br><br>
<strong>Time beats feelings.</strong></p>
<hr>

<h3>4. Who I Tell</h3>
<p><strong>Primary support:</strong> Natalie<br>
<strong>Secondary support:</strong> Carl<br><br>
These people get the early warning, not just the crisis.</p>
<hr>

<h3>5. Preâ€‘Written Prevention Disclosures (Lowâ€‘Detail)</h3>
<p>I choose one sentence and stop:</p>
<ul>
<li>â€œIâ€™m heading into a risky period of timeâ€</li>
<li>â€œNothingâ€™s wrong yet, but this is when my head gets louder.â€</li>
<li>â€œI'm just letting you know that around now is when I typically will have negative thoughts that lead to a lapseâ€</li>
</ul>
<p>I do <b>not</b> explain, justify, or predict relapse.</p>
<hr>

<h3>6. Mandatory Regulation Step (Before Speaking)</h3>
<p>Before I disclose, I regulate my body:</p>
<ul>
<li>â˜ 5 slow breaths (long exhale)</li>
<li>â˜ Cold water on face</li>
<li>â˜ Short cycle on the bike downstairs</li>
<li>â˜ Feet on floor, name 5 things I can see</li>
</ul>
<p>This helps my nervous system feel safe enough to connect.</p>
<hr>

<h3>7. What Help Looks Like in This Window</h3>
<p>I am clear about what I need:</p>
<ul>
<li>â˜ Listening, not fixing</li>
<li>â˜ Brief daily checkâ€‘ins</li>
<li>â˜ Reassurance and normal connection</li>
<li>â˜ More structure and barriers</li>
</ul>
<hr>

<h3>8. If a Lapse Happens (Damageâ€‘Limitation Plan)</h3>
<p>Imperfection is planned for â€” secrecy is not.<br><br>
<b>Timeframe:</b> I disclose the same day before going to bed at latest.<br>
<b>Format</b>: One sentence.<br>
<b>Boundary:</b> â€œI don't want to go through every detail and relive it repeatedlyâ€</p>
<p>Example:</p>
<ul>
<li>â€œI had a slip. Iâ€™m safe now, and I wanted to say it early rather than hide.â€</li>
</ul>
<hr>

<h3>9. Anchor Statement</h3>
<p>â€œMy job isnâ€™t to stay sober perfectly â€” itâ€™s to stay connected early.â€p>
</div>

<h2>Helpful Links</h2>
<div class="links">
<a href="https://www.alcoholics-anonymous.org.uk/" target="_blank">Alcoholics Anonymous</a>
<a href="https://www.alcoholics-anonymous.org.uk/find-a-meeting/" target="_blank">Online AA Meetings</a>
<a href="https://www.avfyww.com" target="_blank">Home Group</a>
</div>

<script>
const title = document.getElementById('title');
const category = document.getElementById('category');
const start = document.getElementById('start');
const end = document.getElementById('end');
const link = document.getElementById('link');
const recurrence = document.getElementById('recurrence');
const sobrietyStart = document.getElementById('sobrietyStart');
const eventForm = document.getElementById('eventForm');
const sobrietyForm = document.getElementById('sobrietyForm');
const soberCounter = document.getElementById('soberCounter');
const eventsDiv = document.getElementById('events');

const todayDate = document.getElementById('todayDate');
const todaySober = document.getElementById('todaySober');
const todayEventsDiv = document.getElementById('todayEvents');
const weekEventsDiv = document.getElementById('weekEvents');

function daysBetween(start) {
  const s = new Date(start);
  const now = new Date();
  return Math.floor((now - s) / (1000*60*60*24));
}

async function loadSobriety() {
  const res = await fetch('/api/sobriety');
  if (!res.ok) return null;
  const data = await res.json();
  if (data.start_date) {
    const days = daysBetween(data.start_date);
    soberCounter.textContent = `âœ¨ ${days} days sober`;
    todaySober.textContent = `âœ¨ ${days} days sober`;
    return days;
  }
  return null;
}

async function loadEvents() {
  // --- Load all events for schedule tab ---
  const resAll = await fetch('/api/events');
  if (!resAll.ok) {
    eventsDiv.textContent = 'Failed to load events.';
    return;
  }
  const allEvents = await resAll.json();
  eventsDiv.innerHTML = '';
  allEvents.forEach(e => {
    const startDate = new Date(e.start);
    const endDate = new Date(e.end);
    const eventEl = document.createElement('div');
    eventEl.className = `event ${e.category}`;
    eventEl.innerHTML = `
      <div>
        <strong>${e.title}</strong>
        ${e.recurrence !== 'None' ? `<span style="font-size:0.85em;color:#666;margin-left:8px;">ğŸ” ${e.recurrence}</span>` : ''}
        <br>
        <span style="font-size:0.9em;color:#444;">
          ${startDate.toLocaleString()} â€“ ${endDate.toLocaleString()}
        </span>
        ${e.link ? `<br><a href='${e.link}' target='_blank'>Link</a>` : ''}
      </div>
    `;
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.className = 'deleteBtn';
    deleteBtn.onclick = async () => {
      if (!confirm(`Delete "${e.title}"?`)) return;
      await fetch(`/api/events/${e.id}`, { method: 'DELETE' });
      loadEvents();
    };
    eventEl.appendChild(deleteBtn);
    eventsDiv.appendChild(eventEl);
  });

  // --- Load today's events ---
  const resToday = await fetch('/api/events/today');
  if (!resToday.ok) {
    todayEventsDiv.textContent = 'Failed to load today\'s events.';
    return;
  }
  const todayEvents = await resToday.json();
  todayEventsDiv.innerHTML = '';
  if (todayEvents.length === 0) todayEventsDiv.textContent = 'No events today.';
  else todayEvents.forEach(e => appendEventToDiv(e, todayEventsDiv));

  // --- Load upcoming events for next 7 days ---
  const now = new Date();
  const nextWeek = new Date();
  nextWeek.setDate(now.getDate() + 7);

  weekEventsDiv.innerHTML = '';
  let upcomingEvents = allEvents.filter(e => {
    const startDate = new Date(e.start);
    if (e.recurrence === 'Daily') return startDate <= nextWeek;
    if (e.recurrence === 'Weekly') return startDate <= nextWeek && startDate.getDay() === now.getDay();
    return startDate >= now && startDate <= nextWeek;
  });

  if (upcomingEvents.length === 0) weekEventsDiv.textContent = 'No upcoming events this week.';
  else upcomingEvents.forEach(e => appendEventToDiv(e, weekEventsDiv));
}

// Helper function to render an event div
function appendEventToDiv(e, container) {
  const startDate = new Date(e.start);
  const endDate = new Date(e.end);
  const el = document.createElement('div');
  el.className = `event ${e.category}`;
  el.innerHTML = `
    <div>
      <strong>${e.title}</strong>
      ${e.recurrence !== 'None' ? `<span style="font-size:0.85em;color:#666;margin-left:8px;">ğŸ” ${e.recurrence}</span>` : ''}
    </div>
    <div style="font-size:0.85em;color:#444;">
      ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€“
      ${endDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
    </div>
    ${e.link ? `<a href='${e.link}' target='_blank'>Link</a>` : ''}
  `;
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Delete';
  deleteBtn.className = 'deleteBtn';
  deleteBtn.onclick = async () => {
    if (!confirm(`Delete "${e.title}"?`)) return;
    await fetch(`/api/events/${e.id}`, { method: 'DELETE' });
    loadEvents();
  };
  el.appendChild(deleteBtn);
  container.appendChild(el);
}

function showTab(tab) {
  document.getElementById('todayTab').style.display = tab === 'today' ? 'block' : 'none';
  document.getElementById('scheduleTab').style.display = tab === 'schedule' ? 'block' : 'none';
  document.getElementById('riskTab').style.display = tab === 'risk' ? 'block' : 'none';
  document.querySelectorAll('.tabBtn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`button[onclick*='${tab}']`).classList.add('active');
}

window.addEventListener('DOMContentLoaded', () => {
  todayDate.textContent = new Date().toDateString();
  loadSobriety();
  loadEvents();

  sobrietyForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/sobriety', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({start_date: sobrietyStart.value})
    });
    loadSobriety();
  };

  eventForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/events', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: title.value,
        category: category.value,
        start: start.value,
        end: end.value,
        link: link.value,
        recurrence: recurrence.value
      })
    });
    loadEvents();
    eventForm.reset();
  };
});
</script>
</body>
</html>
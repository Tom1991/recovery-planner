<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Recovery Planner</title>
<style>
body { font-family: sans-serif; max-width: 900px; margin: 40px auto; }
h2 { margin-top: 32px; }
form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
input, select { padding: 6px; }
.event { padding: 10px; border-left: 4px solid #4caf50; background: #f9f9f9; margin-bottom: 8px; }
.AA { border-color: #1976d2; }
.Personal { border-color: #4caf50; }
.Reminder { border-color: #ff9800; }
.links a { display: block; margin-bottom: 6px; }
.sober { font-size: 1.4em; font-weight: bold; margin-bottom: 16px; }
</style>
</head>
<body>
<h1>ðŸŒ± Recovery Planner</h1>

<!-- Today Dashboard -->
<div id="todayDashboard" style="padding:16px; background:#eef6ee; border-radius:8px; margin-bottom:24px;">
  <h2>Today</h2>
  <div id="todayDate"></div>
  <div id="todaySober">âœ¨ Loading...</div>
  <h3>Today's Events</h3>
  <div id="todayEvents">Loading...</div>
</div>

<div class="sober" id="soberCounter">âœ¨ Loading...</div>

<form id="sobrietyForm">
<label>Sobriety start date:</label>
<input type="date" id="sobrietyStart" />
<button>Save</button>
</form>

<h2>Add Event / Meeting</h2>
<form id="eventForm">
<input placeholder="Title" id="title" required />
<select id="category">
<option>Personal</option>
<option>AA</option>
<option>Reminder</option>
</select>
<input type="datetime-local" id="start" required />
<input type="datetime-local" id="end" required />
<input placeholder="Optional link" id="link" />
<select id="recurrence">
<option>None</option>
<option>Daily</option>
<option>Weekly</option>
</select>
<button>Add</button>
</form>

<h2>Your Schedule</h2>
<div id="events"></div>

<h2>Helpful Links</h2>
<div class="links">
<a href="https://www.alcoholics-anonymous.org.uk/" target="_blank">Alcoholics Anonymous</a>
<a href="https://www.alcoholics-anonymous.org.uk/find-a-meeting/" target="_blank">Online AA Meetings</a>
</div>

<script>
const title = document.getElementById('title');
const category = document.getElementById('category');
const start = document.getElementById('start');
const end = document.getElementById('end');
const link = document.getElementById('link');
const recurrence = document.getElementById('recurrence');
const sobrietyStart = document.getElementById('sobrietyStart');
const eventForm = document.getElementById('eventForm');
const sobrietyForm = document.getElementById('sobrietyForm');
const soberCounter = document.getElementById('soberCounter');
const eventsDiv = document.getElementById('events');

const todayDate = document.getElementById('todayDate');
const todaySober = document.getElementById('todaySober');
const todayEventsDiv = document.getElementById('todayEvents');

function daysBetween(start) {
  const s = new Date(start);
  const now = new Date();
  return Math.floor((now - s) / (1000*60*60*24));
}

async function loadSobriety() {
  const res = await fetch('/api/sobriety');
  if (!res.ok) return null;
  const data = await res.json();
  if (data.start_date) {
    const days = daysBetween(data.start_date);
    soberCounter.textContent = `âœ¨ ${days} days sober`;
    todaySober.textContent = `âœ¨ ${days} days sober`;
    return days;
  }
  return null;
}

async function loadEvents(todayOnly=false) {
  const res = await fetch('/api/events');
  if (!res.ok) {
    todayEventsDiv.textContent = 'Failed to load events.';
    return;
  }
  const events = await res.json();

  

  eventsDiv.innerHTML = '';
  todayEventsDiv.innerHTML = '';

  const todayStr = new Date().toDateString();

  events.forEach(e => {
    const startDate = new Date(e.start);
    const endDate = new Date(e.end);

    // main schedule
    const eventEl = document.createElement('div');
    eventEl.className = `event ${e.category}`;
    eventEl.innerHTML = `<strong>${e.title}</strong> <br> ${startDate.toLocaleString()} - ${endDate.toLocaleString()} ${e.link ? `<br><a href='${e.link}' target='_blank'>Link</a>` : ''}`;
    eventsDiv.appendChild(eventEl);

    // Add delete button
const deleteBtn = document.createElement('button');
deleteBtn.textContent = 'Delete';
deleteBtn.style.marginLeft = '8px';
deleteBtn.onclick = async () => {
    await fetch(`/api/events/${e.id}`, { method: 'DELETE' });
    loadEvents(true); // reload events including Today Dashboard
};
eventEl.appendChild(deleteBtn);

eventsDiv.appendChild(eventEl);

    // Today Dashboard
    if (todayOnly && startDate.toDateString() === todayStr) {
      const todayEl = document.createElement('div');
      todayEl.className = `event ${e.category}`;
      todayEl.innerHTML = `<strong>${e.title}</strong> ${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()} ${e.link ? `<br><a href='${e.link}' target='_blank'>Link</a>` : ''}`;
      todayEventsDiv.appendChild(todayEl);
    }
  });

  if (todayOnly && todayEventsDiv.innerHTML === '') {
    todayEventsDiv.textContent = 'No events today.';
  }
}

window.addEventListener('DOMContentLoaded', () => {
  todayDate.textContent = new Date().toDateString();
  loadSobriety();
  loadEvents(true);

  sobrietyForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/sobriety', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({start_date: sobrietyStart.value})
    });
    loadSobriety();
  };

  eventForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/events', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        title: title.value,
        category: category.value,
        start: start.value,
        end: end.value,
        link: link.value,
        recurrence: recurrence.value
      })
    });
    loadEvents(true);
    eventForm.reset();
  };
});
</script>
</body>
</html>

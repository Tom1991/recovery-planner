<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Recovery Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Roboto', sans-serif; max-width: 900px; margin: 40px auto; background: #f5f7f8; color: #333; }
  h1 { text-align: center; }

  button.tabBtn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; background: #eee; transition: background 0.2s; }
  button.tabBtn.active { background: #4caf50; color: #fff; }
  button.tabBtn:hover { background: #ddd; }

  form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  input, select, button, textarea { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }

  button.submitBtn { background: #4caf50; color: white; cursor: pointer; border: none; transition: background 0.2s; }
  button.submitBtn:hover { background: #43a047; }

  .event {
    padding: 10px;
    border-left: 4px solid #4caf50;
    background: #fff;
    margin-bottom: 8px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .event-info {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    font-size: 0.9em;
    color:#444;
  }

  .event-info a { font-size:0.9em; color:#1976d2; text-decoration:none; }
  .event-info a:hover { text-decoration:underline; }

  .AA { border-color: #1976d2; }
  .Personal { border-color: #4caf50; }
  .Reminder { border-color: #ff9800; }

  #todayDashboard { padding:16px; background:#e6f4ea; border-radius:12px; margin-bottom:24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

  .links a { display: inline-block; margin-bottom: 6px; color:#1976d2; text-decoration:none; }
  .links a:hover { text-decoration: underline; }

  .sober { font-size: 1.4em; font-weight: bold; margin-bottom: 16px; }

  .deleteBtn { background: #e53935; margin-left: 8px; padding: 4px 8px; border:none; border-radius:4px; color:white; cursor:pointer; }
  .deleteBtn:hover { background: #d32f2f; }

  /* Diary styling: vertical flow */
  #diaryWrap {
    background:#fff;
    padding:16px;
    border-radius:12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  #diaryNav { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
  #diaryNav button { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; background:#f5f5f5; cursor:pointer; }
  #diaryNav button:hover { background:#eee; }

  #diaryPrompt { margin-bottom:12px; color:#d32f2f; font-style: italic; }

  #diaryForm {
    display:flex;
    flex-direction:column;
    gap:12px;
    background:#fff;
    padding:0;
    border-radius:0;
    box-shadow:none;
    margin:0;
  }

  #diaryForm label { font-weight:700; margin-top:6px; }
  #diaryForm input, #diaryForm textarea { width:100%; }
  #diaryForm textarea { resize: vertical; }

  .diarySmall { font-size: 0.9em; color:#666; margin-top:-6px; }

  .diarySaveBtn {
    background:#4caf50;
    color:white;
    border:none;
    border-radius:8px;
    padding:12px 16px;
    cursor:pointer;
    width: fit-content;
  }
  .diarySaveBtn:hover { background:#43a047; }

</style>
</head>

<body>
<h1>üå± Recovery Planner</h1>

<!-- Tabs -->
<div id="nav" style="display:flex; gap:16px; margin-bottom:24px; justify-content:center;">
  <button class="tabBtn active" onclick="showTab('today')">Today</button>
  <button class="tabBtn" onclick="showTab('schedule')">Scheduler</button>
  <button class="tabBtn" onclick="showTab('risk')">Risk Cycle</button>
  <button class="tabBtn" onclick="showTab('diary')">Diary</button>
</div>

<!-- Today Tab -->
<div id="todayTab">
  <div id="todayDashboard">
    <h2>Today</h2>
    <div id="todayDate"></div>
    <div id="todaySober">‚ú® Loading...</div>

    <h3>Today's Affirmation</h3>
    <div id="todayAffirmation" style="font-style:italic; margin-bottom:16px;">Loading...</div>

    <h3>Today's Events</h3>
    <div id="todayEvents">Loading...</div>

    <h3>Upcoming Events This Week</h3>
    <div id="weekEvents">Loading...</div>
  </div>
</div>

<!-- Schedule Tab -->
<div id="scheduleTab" style="display:none;">
  <div class="sober" id="soberCounter">‚ú® Loading...</div>

  <form id="sobrietyForm">
    <label>Sobriety start date:</label>
    <input type="date" id="sobrietyStart" />
    <button class="submitBtn" type="submit">Save</button>
  </form>

  <h2>Add Event / Meeting</h2>
  <form id="eventForm">
    <input placeholder="Title" id="title" required />
    <select id="category">
      <option>Personal</option>
      <option>AA</option>
      <option>Reminder</option>
    </select>
    <input type="datetime-local" id="start" required />
    <input type="datetime-local" id="end" required />
    <input placeholder="Optional link" id="link" />
    <select id="recurrence">
      <option>None</option>
      <option>Daily</option>
      <option>Weekly</option>
    </select>
    <button class="submitBtn" type="submit">Add</button>
  </form>

  <h2>Your Schedule</h2>
  <div id="events"></div>
</div>

<!-- Risk Cycle Tab (kept as you had it) -->
<div id="riskTab" style="display:none;" class="card">
  <h2>üß† 2‚Äì3 Week Cycle Prevention & Honesty Plan</h2>
  <p><strong>Purpose:</strong> Interrupt my predictable 2‚Äì3 week risk cycle by prioritising early connection, low-detail honesty, and nervous-system regulation.</p>

  <h3>1. Name the Pattern</h3>
  <p><strong>Cycle name:</strong> The Danger Zone<br><strong>Typical timing:</strong> Around weeks 2‚Äì3 after a stable period.</p>
  <hr>

  <h3>2. Early Warning Signs</h3>
  <ul>
    <li>‚òê Avoiding check ins</li>
    <li>‚òê Thinking "I don‚Äôt want to burden anyone"</li>
    <li>‚òê Fantasising about relief/escape</li>
    <li>‚òê Thinking about future events where a drink "won't be allowed"</li>
    <li>‚òê Not filling in my diary within 24 hours</li>
  </ul>
  <p><strong>Rule:</strong> If two or more, act immediately ‚Äî no debate.</p>
  <hr>

  <h3>3. Time-Based Intervention</h3>
  <p>On Day <b>12‚Äì22</b>, proactively check in.<br>Or every weekend regardless of mood.<br><strong>Time beats feelings.</strong></p>
  <hr>

  <h3>4. Who I Tell</h3>
  <p><strong>Primary:</strong> Natalie<br><strong>Secondary:</strong> Carl</p>
  <hr>

  <h3>5. Pre-Written Disclosures</h3>
  <ul>
    <li>‚ÄúI‚Äôm heading into a risky period of time‚Äù</li>
    <li>‚ÄúNothing‚Äôs wrong yet, but this is when my head gets louder.‚Äù</li>
    <li>‚ÄúI'm just letting you know that around now is when my thoughts lead to a lapse‚Äù</li>
  </ul>
  <p>I do <b>not</b> explain or predict relapse.</p>
  <hr>

  <h3>6. Mandatory Regulation</h3>
  <ul>
    <li>‚òê 5 slow breaths</li>
    <li>‚òê Cold water on face</li>
    <li>‚òê Short bike cycle</li>
    <li>‚òê Feet on floor, name 5 things you see</li>
  </ul>
  <hr>

  <h3>7. What Help Looks Like</h3>
  <ul>
    <li>‚òê Listening, not fixing</li>
    <li>‚òê Brief daily check-ins</li>
    <li>‚òê Reassurance</li>
    <li>‚òê More structure</li>
  </ul>
  <hr>

  <h3>8. If a Lapse Happens</h3>
  <p>Imperfection is planned ‚Äî secrecy is not.<br><b>Timeframe:</b> Same day before bed<br><b>Format:</b> One sentence<br><b>Boundary:</b> ‚ÄúI don't want to go through every detail repeatedly‚Äù</p>
  <ul>
    <li>‚ÄúI had a slip. I‚Äôm safe now, and I wanted to say it early rather than hide.‚Äù</li>
  </ul>
  <hr>

  <h3>9. Anchor Statement</h3>
  <p>‚ÄúMy job isn‚Äôt to stay sober perfectly ‚Äî it‚Äôs to stay connected early.‚Äù</p>
</div>

<!-- Diary Tab -->
<div id="diaryTab" style="display:none;">
  <div id="diaryWrap">

    <div id="diaryNav">
      <button type="button" onclick="changeDiaryDate(-1)">‚Üê Previous Day</button>
      <div id="diaryDateDisplay" style="font-weight:700;"></div>
      <button type="button" onclick="changeDiaryDate(1)">Next Day ‚Üí</button>
    </div>

    <div id="diaryPrompt"></div>

    <form id="diaryForm">
      <label for="goal">Goal for the day:</label>
      <textarea id="goal" rows="2" placeholder="Your goal for today..."></textarea>

      <label>3 Things I am grateful for today:</label>
      <input id="grateful1" type="text" placeholder="Grateful 1">
      <input id="grateful2" type="text" placeholder="Grateful 2">
      <input id="grateful3" type="text" placeholder="Grateful 3">

      <label>3 Emotions:</label>
      <input id="emotion1" type="text" placeholder="Emotion 1">
      <input id="emotion2" type="text" placeholder="Emotion 2">
      <input id="emotion3" type="text" placeholder="Emotion 3">

      <label for="cravings">Cravings (0‚Äì10):</label>
      <input id="cravings" type="number" min="0" max="10" placeholder="0">

      <label for="morning">Morning:</label>
      <textarea id="morning" rows="4" placeholder="Morning notes..."></textarea>

      <label for="afternoon">Afternoon:</label>
      <textarea id="afternoon" rows="4" placeholder="Afternoon notes..."></textarea>

      <label for="evening">Evening:</label>
      <textarea id="evening" rows="4" placeholder="Evening notes..."></textarea>

      <button class="diarySaveBtn" type="submit">Save Entry</button>
      <div class="diarySmall" id="diaryStatus"></div>
    </form>

  </div>
</div>

<h2>Helpful Links</h2>
<div class="links">
  <a href="https://www.alcoholics-anonymous.org.uk/" target="_blank">Alcoholics Anonymous</a>
  <a href="https://www.alcoholics-anonymous.org.uk/find-a-meeting/" target="_blank">Online AA Meetings</a>
  <a href="https://www.avfyww.com" target="_blank">Home Meeting</a>
</div>

<script src="affirmations.js"></script>
<script>
/* ---------------- Elements ---------------- */
const titleEl = document.getElementById('title');
const categoryEl = document.getElementById('category');
const startEl = document.getElementById('start');
const endEl = document.getElementById('end');
const linkEl = document.getElementById('link');
const recurrenceEl = document.getElementById('recurrence');
const sobrietyStartEl = document.getElementById('sobrietyStart');
const eventForm = document.getElementById('eventForm');
const sobrietyForm = document.getElementById('sobrietyForm');

const soberCounter = document.getElementById('soberCounter');
const todayDateEl = document.getElementById('todayDate');
const todaySoberEl = document.getElementById('todaySober');
const todayAffirmationEl = document.getElementById('todayAffirmation');
const eventsDiv = document.getElementById('events');
const todayEventsDiv = document.getElementById('todayEvents');
const weekEventsDiv = document.getElementById('weekEvents');

/* Diary elements */
const diaryForm = document.getElementById('diaryForm');
const diaryDateDisplay = document.getElementById('diaryDateDisplay');
const diaryPromptEl = document.getElementById('diaryPrompt');
const diaryStatusEl = document.getElementById('diaryStatus');

const goalEl = document.getElementById('goal');
const grateful1El = document.getElementById('grateful1');
const grateful2El = document.getElementById('grateful2');
const grateful3El = document.getElementById('grateful3');
const emotion1El = document.getElementById('emotion1');
const emotion2El = document.getElementById('emotion2');
const emotion3El = document.getElementById('emotion3');
const cravingsEl = document.getElementById('cravings');
const morningEl = document.getElementById('morning');
const afternoonEl = document.getElementById('afternoon');
const eveningEl = document.getElementById('evening');

/* ---------------- Utilities ---------------- */
function showTab(tab){
  document.getElementById('todayTab').style.display = tab==='today' ? 'block' : 'none';
  document.getElementById('scheduleTab').style.display = tab==='schedule' ? 'block' : 'none';
  document.getElementById('riskTab').style.display = tab==='risk' ? 'block' : 'none';
  document.getElementById('diaryTab').style.display = tab==='diary' ? 'block' : 'none';

  document.querySelectorAll('.tabBtn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`button[onclick*="${tab}"]`).classList.add('active');
}

function startOfDay(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}
function formatISODate(d){
  // YYYY-MM-DD in local time
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function daysBetweenDates(a, b){
  // difference in whole days between two Date objects (date-only)
  const aa = startOfDay(a).getTime();
  const bb = startOfDay(b).getTime();
  return Math.floor((bb - aa) / (1000*60*60*24));
}

function nextOccurrence(e){
  const s = new Date(e.start);
  const today = startOfDay(new Date());

  if(e.recurrence === 'None') return s;

  if(e.recurrence === 'Daily'){
    // show every day from start date onwards
    return today < startOfDay(s) ? s : today;
  }

  if(e.recurrence === 'Weekly'){
    const sDay = s.getDay();
    const tDay = today.getDay();
    const diff = (sDay - tDay + 7) % 7;
    const next = new Date(today);
    next.setDate(today.getDate() + diff);
    return next < startOfDay(s) ? s : next;
  }

  return s;
}

/* ---------------- Sobriety ---------------- */
let sobrietyStartISO = null;

async function loadSobriety(){
  const res = await fetch('/api/sobriety');
  if(!res.ok) return;
  const data = await res.json();
  if(data.start_date){
    sobrietyStartISO = data.start_date; // usually "YYYY-MM-DD"
    const start = new Date(data.start_date);
    const days = daysBetweenDates(start, new Date());
    soberCounter.textContent = `‚ú® ${days} days sober`;
    todaySoberEl.textContent = `‚ú® ${days} days sober`;
  }
}

/* ---------------- Events ---------------- */
function buildEventElement(e){
  const s = new Date(e.start);
  const en = new Date(e.end);

  const el = document.createElement('div');
  el.className = `event ${e.category}`;

  const info = document.createElement('div');
  info.className = 'event-info';

  const recurrencePart = (e.recurrence && e.recurrence !== 'None')
    ? `<span style="font-size:0.85em;color:#666;">üîÅ ${e.recurrence}</span>`
    : '';

  const linkPart = e.link ? `<a href="${e.link}" target="_blank" rel="noopener">Link</a>` : '';

  info.innerHTML = `
    <strong>${e.title}</strong>
    ${recurrencePart}
    <span>${s.toLocaleDateString()} ${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ‚Äì ${en.toLocaleDateString()} ${en.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
    ${linkPart}
  `;

  const del = document.createElement('button');
  del.textContent = 'Delete';
  del.className = 'deleteBtn';
  del.onclick = async () => {
    const ok = confirm(`Delete "${e.title}"?\nThis cannot be undone.`);
    if(!ok) return;
    await fetch(`/api/events/${e.id}`, { method: 'DELETE' });
    loadEvents();
  };

  el.appendChild(info);
  el.appendChild(del);
  return el;
}

async function loadEvents(){
  const res = await fetch('/api/events');
  if(!res.ok) return;
  const allEvents = await res.json();

  eventsDiv.innerHTML = '';
  todayEventsDiv.innerHTML = '';
  weekEventsDiv.innerHTML = '';

  // Schedule list (all)
  allEvents.forEach(e => eventsDiv.appendChild(buildEventElement(e)));

  // Today + next 7 days (based on recurrence)
  const today = startOfDay(new Date());
  const endWeek = new Date(today);
  endWeek.setDate(today.getDate() + 7);

  const todayList = [];
  const weekList = [];

  allEvents.forEach(e => {
    const occ = startOfDay(nextOccurrence(e));
    if(occ.getTime() === today.getTime()){
      todayList.push(e);
    } else if(occ > today && occ <= endWeek){
      weekList.push(e);
    }
  });

  if(todayList.length === 0){
    todayEventsDiv.textContent = 'No events today.';
  } else {
    todayList.forEach(e => todayEventsDiv.appendChild(buildEventElement(e)));
  }

  if(weekList.length === 0){
    weekEventsDiv.textContent = 'No upcoming events this week.';
  } else {
    weekList.forEach(e => weekEventsDiv.appendChild(buildEventElement(e)));
  }
}

/* ---------------- Affirmation ---------------- */
function setAffirmation(){
  if(typeof affirmations === 'undefined' || !Array.isArray(affirmations) || affirmations.length === 0){
    todayAffirmationEl.textContent = 'Affirmations not loaded.';
    return;
  }
  const today = new Date();
  const start = new Date(today.getFullYear(), 0, 0);
  const dayOfYear = Math.floor((today - start) / (1000*60*60*24));
  todayAffirmationEl.textContent = affirmations[dayOfYear % affirmations.length];
}

/* ---------------- Diary ---------------- */
let diaryDate = new Date();

function setDiaryPrompt(){
  diaryPromptEl.textContent = '';
  if(!sobrietyStartISO) return;

  const start = new Date(sobrietyStartISO);
  const dayNum = daysBetweenDates(start, diaryDate) + 1; // day 1 = start day

  if(dayNum >= 12 && dayNum <= 22){
    diaryPromptEl.textContent = '‚ö†Ô∏è This date falls into your 2‚Äì3 week risk cycle. Have you checked in today?';
  }
}

function clearDiaryFields(){
  goalEl.value = '';
  grateful1El.value = '';
  grateful2El.value = '';
  grateful3El.value = '';
  emotion1El.value = '';
  emotion2El.value = '';
  emotion3El.value = '';
  cravingsEl.value = '';
  morningEl.value = '';
  afternoonEl.value = '';
  eveningEl.value = '';
}

async function loadDiary(){
  diaryStatusEl.textContent = '';
  diaryDateDisplay.textContent = diaryDate.toDateString();
  setDiaryPrompt();

  const iso = formatISODate(diaryDate);
  const res = await fetch(`/api/diary/${iso}`);
  if(!res.ok){
    // if server returns 404/empty, we just clear fields
    clearDiaryFields();
    return;
  }
  const data = await res.json();

  // If empty object returned, clear
  if(!data || Object.keys(data).length === 0){
    clearDiaryFields();
    return;
  }

  goalEl.value = data.goal || '';
  grateful1El.value = data.grateful1 || '';
  grateful2El.value = data.grateful2 || '';
  grateful3El.value = data.grateful3 || '';
  emotion1El.value = data.emotion1 || '';
  emotion2El.value = data.emotion2 || '';
  emotion3El.value = data.emotion3 || '';
  cravingsEl.value = (data.cravings === null || data.cravings === undefined) ? '' : data.cravings;
  morningEl.value = data.morning || '';
  afternoonEl.value = data.afternoon || '';
  eveningEl.value = data.evening || '';
}

function changeDiaryDate(delta){
  diaryDate.setDate(diaryDate.getDate() + delta);
  loadDiary();
}

diaryForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  diaryStatusEl.textContent = 'Saving...';

  const payload = {
    date: formatISODate(diaryDate),
    goal: goalEl.value,
    grateful1: grateful1El.value,
    grateful2: grateful2El.value,
    grateful3: grateful3El.value,
    emotion1: emotion1El.value,
    emotion2: emotion2El.value,
    emotion3: emotion3El.value,
    cravings: cravingsEl.value === '' ? null : Number(cravingsEl.value),
    morning: morningEl.value,
    afternoon: afternoonEl.value,
    evening: eveningEl.value
  };

  const res = await fetch('/api/diary', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    diaryStatusEl.textContent = 'Save failed. Check server logs.';
    return;
  }

  diaryStatusEl.textContent = 'Saved ‚úÖ';
});

/* ---------------- Forms: Sobriety + Events ---------------- */
sobrietyForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  await fetch('/api/sobriety', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ start_date: sobrietyStartEl.value })
  });
  await loadSobriety();
  // prompt might change for diary
  setDiaryPrompt();
});

eventForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  await fetch('/api/events', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      title: titleEl.value,
      category: categoryEl.value,
      start: startEl.value,
      end: endEl.value,
      link: linkEl.value,
      recurrence: recurrenceEl.value
    })
  });
  await loadEvents();
  eventForm.reset();
});

/* ---------------- On load ---------------- */
window.addEventListener('DOMContentLoaded', async () => {
  todayDateEl.textContent = new Date().toDateString();
  await loadSobriety();
  await loadEvents();
  setAffirmation();
  await loadDiary();
});
</script>
</body>
</html>

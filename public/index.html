<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Recovery Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; max-width: 900px; margin: 40px auto; background: #f5f7f8; color: #333; }
h1 { text-align: center; }
button.tabBtn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; background: #eee; transition: background 0.2s; }
button.tabBtn.active { background: #4caf50; color: #fff; }
button.tabBtn:hover { background: #ddd; }
form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
input, select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
button.submitBtn { background: #4caf50; color: white; cursor: pointer; border: none; transition: background 0.2s; }
button.submitBtn:hover { background: #43a047; }
.event { padding: 10px; border-left: 4px solid #4caf50; background: #fff; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
.AA { border-color: #1976d2; }
.Personal { border-color: #4caf50; }
.Reminder { border-color: #ff9800; }
#todayDashboard { padding:16px; background:#e6f4ea; border-radius:12px; margin-bottom:24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.links a { display: inline-block; margin-bottom: 6px; color:#1976d2; text-decoration:none; }
.links a:hover { text-decoration: underline; }
.sober { font-size: 1.4em; font-weight: bold; margin-bottom: 16px; }
.deleteBtn { background: #e53935; margin-left: 8px; }
.deleteBtn:hover { background: #d32f2f; }
</style>
</head>
<body>
<h1>üå± Recovery Planner</h1>

<!-- Navigation Tabs -->
<div id="nav" style="display:flex; gap:16px; margin-bottom:24px; justify-content:center;">
  <button class="tabBtn active" onclick="showTab('today')">Today</button>
  <button class="tabBtn" onclick="showTab('schedule')">Scheduler</button>
  <button class="tabBtn" onclick="showTab('risk')">Risk Cycle</button>
</div>

<!-- Today Tab -->
<div id="todayTab">
  <div id="todayDashboard">
    <h2>Today</h2>
    <div id="todayDate"></div>
    <div id="todaySober">‚ú® Loading...</div>
    <h3>Today's Events</h3>
    <div id="todayEvents">Loading...</div>
  </div>
</div>

<!-- Schedule Tab -->
<div id="scheduleTab" style="display:none;">
  <div class="sober" id="soberCounter">‚ú® Loading...</div>

  <form id="sobrietyForm">
    <label>Sobriety start date:</label>
    <input type="date" id="sobrietyStart" />
    <button class="submitBtn">Save</button>
  </form>

  <h2>Add Event / Meeting</h2>
  <form id="eventForm">
    <input placeholder="Title" id="title" required />
    <select id="category">
      <option>Personal</option>
      <option>AA</option>
      <option>Reminder</option>
    </select>
    <input type="datetime-local" id="start" required />
    <input type="datetime-local" id="end" required />
    <input placeholder="Optional link" id="link" />
    <select id="recurrence">
      <option>None</option>
      <option>Daily</option>
      <option>Weekly</option>
    </select>
    <button class="submitBtn">Add</button>
  </form>

  <h2>Your Schedule</h2>
  <div id="events"></div>
</div>

<div id="riskTab" style="display:none;" class="card">
  <h2>üß† 2‚Äì3 Week Cycle Prevention & Honesty Plan</h2>
  <p><strong>Purpose:</strong> Interrupt my predictable 2‚Äì3 week risk cycle by prioritising early connection, low‚Äëdetail honesty, and nervous‚Äësystem regulation.</p>

  <h3>1. Name the Pattern</h3>
  <p><strong>Cycle name:</strong> The Danger Zone<br>
  <strong>Typical timing:</strong> Around weeks 2 to 3 weeks after a stable period.</p>
  <hr>

  <h3>2. Early Warning Signs (Before Urges)</h3>
  <p>When this phase starts, I often notice:</p>
  <ul>
    <li>‚òê Avoiding check ins</li>
    <li>‚òê Thinking "I don‚Äôt want to burden anyone"</li>
    <li>‚òê Fantasising about relief/escape</li>
    <li>‚òê Thinking about future events where a drink "won't be allowed"</li>
    <li>‚òê Not filling in my diary at least within 24 hours of the day before</li>
  </ul>
  <p><strong>Rule:</strong> If I notice two or more of these, I act ‚Äî no debate.</p>
  <hr>
  <h3>3. Time‚ÄëBased Intervention Rule - To be removed post risk period</h3>
  <p>I do not wait until I feel bad enough.<br><br>
  On Day <b>12 to 22</b>, I proactively check in.<br>
  OR: Every weekend, regardless of mood.<br><br>
  <strong>Time beats feelings.</strong></p>
  <hr>
  <h3>4. Who I Tell</h3>
  <p><strong>Primary support:</strong> Natalie<br>
  <strong>Secondary support:</strong> Carl<br><br>
  These people get the early warning, not just the crisis.</p>
  <hr>
  <h3>5. Pre‚ÄëWritten Prevention Disclosures (Low‚ÄëDetail)</h3>
  <p>I choose one sentence and stop:</p>
  <ul>
    <li>‚ÄúI‚Äôm heading into a risky period of time‚Äù</li>
    <li>‚ÄúNothing‚Äôs wrong yet, but this is when my head gets louder.‚Äù</li>
    <li>‚ÄúI'm just letting you know that around now is when I typically will have negative thoughts that lead to a lapse‚Äù</li>
  </ul>
  <p>I do <b>not</b> explain, justify, or predict relapse.</p>
  <hr>
  <h3>6. Mandatory Regulation Step (Before Speaking)</h3>
  <p>Before I disclose, I regulate my body:</p>
  <ul>
    <li>‚òê 5 slow breaths (long exhale)</li>
    <li>‚òê Cold water on face</li>
    <li>‚òê Short cycle on the bike downstairs</li>
    <li>‚òê Feet on floor, name 5 things I can see</li>
  </ul>
  <p>This helps my nervous system feel safe enough to connect.</p>
  <hr>
  <h3>7. What Help Looks Like in This Window</h3>
  <p>I am clear about what I need:</p>
  <ul>
    <li>‚òê Listening, not fixing</li>
    <li>‚òê Brief daily check‚Äëins</li>
    <li>‚òê Reassurance and normal connection</li>
    <li>‚òê More structure and barriers</li>
  </ul>
  <hr>
  <h3>8. If a Lapse Happens (Damage‚ÄëLimitation Plan)</h3>
  <p>Imperfection is planned for ‚Äî secrecy is not.<br><br>
  <b>Timeframe:</b> I disclose the same day before going to bed at latest.<br>
  <b>Format</b>: One sentence.<br>
  <b>Boundary:</b> ‚ÄúI don't want to go through every detail and relive it repeatedly‚Äù</p>
  <p>Example:</p>
  <ul>
    <li>‚ÄúI had a slip. I‚Äôm safe now, and I wanted to say it early rather than hide.‚Äù</li>
  </ul>
  <hr>
  <h3>9. Anchor Statement</h3>
  <p>‚ÄúMy job isn‚Äôt to stay sober perfectly ‚Äî it‚Äôs to stay connected early.‚Äù</p>
</div>



<h2>Helpful Links</h2>
<div class="links">
  <a href="https://www.alcoholics-anonymous.org.uk/" target="_blank">Alcoholics Anonymous</a>
  <a href="https://www.alcoholics-anonymous.org.uk/find-a-meeting/" target="_blank">Online AA Meetings</a>
  <a href="https://www.avfyww.com" target="_blank">Home Meeting</a>
</div>

<script>
const title = document.getElementById('title');
const category = document.getElementById('category');
const start = document.getElementById('start');
const end = document.getElementById('end');
const link = document.getElementById('link');
const recurrence = document.getElementById('recurrence');
const sobrietyStart = document.getElementById('sobrietyStart');
const eventForm = document.getElementById('eventForm');
const sobrietyForm = document.getElementById('sobrietyForm');
const soberCounter = document.getElementById('soberCounter');
const eventsDiv = document.getElementById('events');

const todayDate = document.getElementById('todayDate');
const todaySober = document.getElementById('todaySober');
const todayEventsDiv = document.getElementById('todayEvents');

function daysBetween(start) {
  const s = new Date(start);
  const now = new Date();
  return Math.floor((now - s) / (1000*60*60*24));
}

async function loadSobriety() {
  const res = await fetch('/api/sobriety');
  if (!res.ok) return null;
  const data = await res.json();
  if (data.start_date) {
    const days = daysBetween(data.start_date);
    soberCounter.textContent = `‚ú® ${days} days sober`;
    todaySober.textContent = `‚ú® ${days} days sober`;
    return days;
  }
  return null;
}

async function loadEvents(todayOnly=false) {
  const res = await fetch('/api/events');
  if (!res.ok) {
    todayEventsDiv.textContent = 'Failed to load events.';
    return;
  }
  const events = await res.json();

  eventsDiv.innerHTML = '';
  todayEventsDiv.innerHTML = '';

  const todayStr = new Date().toDateString();

  events.forEach(e => {
    const startDate = new Date(e.start);
    const endDate = new Date(e.end);

    // Main schedule
    const eventEl = document.createElement('div');
    eventEl.className = `event ${e.category}`;
    eventEl.innerHTML = `<div><strong>${e.title}</strong><br>${startDate.toLocaleString()} - ${endDate.toLocaleString()}${e.link ? `<br><a href='${e.link}' target='_blank'>Link</a>` : ''}</div>`;

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.className = 'deleteBtn';
    deleteBtn.onclick = async () => {
      await fetch(`/api/events/${e.id}`, { method: 'DELETE' });
      loadEvents(true);
    };
    eventEl.appendChild(deleteBtn);

    eventsDiv.appendChild(eventEl);

    // Today Dashboard
    if (todayOnly && startDate.toDateString() === todayStr) {
      const todayEl = document.createElement('div');
      todayEl.className = `event ${e.category}`;
      todayEl.innerHTML = `<strong>${e.title}</strong> ${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()}${e.link ? `<br><a href='${e.link}' target='_blank'>Link</a>` : ''}`;
      todayEventsDiv.appendChild(todayEl);
    }
  });

  if (todayOnly && todayEventsDiv.innerHTML === '') {
    todayEventsDiv.textContent = 'No events today.';
  }
}

function showTab(tab) {
  document.getElementById('todayTab').style.display = tab === 'today' ? 'block' : 'none';
  document.getElementById('scheduleTab').style.display = tab === 'schedule' ? 'block' : 'none';
  document.getElementById('riskTab').style.display = tab === 'risk' ? 'block' : 'none';
  document.querySelectorAll('.tabBtn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`button[onclick*='${tab}']`).classList.add('active');
}

window.addEventListener('DOMContentLoaded', () => {
  todayDate.textContent = new Date().toDateString();
  loadSobriety();
  loadEvents(true);

  sobrietyForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/sobriety', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({start_date: sobrietyStart.value})
    });
    loadSobriety();
  };

  eventForm.onsubmit = async e => {
    e.preventDefault();
    await fetch('/api/events', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        title: title.value,
        category: category.value,
        start: start.value,
        end: end.value,
        link: link.value,
        recurrence: recurrence.value
      })
    });
    loadEvents(true);
    eventForm.reset();
  };
});
</script>
</body>
</html>
